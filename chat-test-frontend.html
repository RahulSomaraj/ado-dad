<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Test Frontend</title>
    <script src="https://cdn.socket.io/4.7.3/socket.io.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        text-align: center;
      }

      .header h1 {
        font-size: 2rem;
        margin-bottom: 10px;
      }

      .connection-status {
        display: inline-block;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: bold;
      }

      .status-connected {
        background: #4caf50;
        color: white;
      }

      .status-disconnected {
        background: #f44336;
        color: white;
      }

      .main-content {
        display: grid;
        grid-template-columns: 300px 1fr;
        height: 600px;
      }

      .sidebar {
        background: #f8f9fa;
        border-right: 1px solid #e9ecef;
        padding: 20px;
        overflow-y: auto;
      }

      .chat-area {
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .chat-header {
        background: #f8f9fa;
        padding: 15px 20px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #fafafa;
      }

      .chat-input {
        padding: 20px;
        border-top: 1px solid #e9ecef;
        background: white;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-primary:hover {
        background: #5a6fd8;
      }

      .btn-success {
        background: #28a745;
        color: white;
      }

      .btn-success:hover {
        background: #218838;
      }

      .btn-danger {
        background: #dc3545;
        color: white;
      }

      .btn-danger:hover {
        background: #c82333;
      }

      .message {
        margin-bottom: 15px;
        padding: 10px 15px;
        border-radius: 10px;
        max-width: 70%;
        word-wrap: break-word;
      }

      .message.sent {
        background: #667eea;
        color: white;
        margin-left: auto;
      }

      .message.received {
        background: #e9ecef;
        color: #333;
      }

      .message-header {
        font-size: 0.8rem;
        margin-bottom: 5px;
        opacity: 0.8;
      }

      .chat-list {
        list-style: none;
      }

      .chat-item {
        padding: 10px;
        border: 1px solid #e9ecef;
        border-radius: 5px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .chat-item:hover {
        background: #e9ecef;
      }

      .chat-item.active {
        background: #667eea;
        color: white;
      }

      .input-group {
        display: flex;
        gap: 10px;
      }

      .input-group input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }

      .log-area {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 5px;
        padding: 10px;
        height: 100px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
        margin-top: 15px;
      }

      .tabs {
        display: flex;
        border-bottom: 1px solid #e9ecef;
      }

      .tab {
        flex: 1;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
      }

      .tab.active {
        border-bottom-color: #667eea;
        background: #f8f9fa;
      }

      .tab-content {
        display: none;
        padding: 20px;
      }

      .tab-content.active {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Chat Test Frontend</h1>
        <div class="connection-status" id="connectionStatus">Disconnected</div>
      </div>

      <div class="main-content">
        <div class="sidebar">
          <div class="tabs">
            <div class="tab active" onclick="switchTab('setup', event)">
              Setup
            </div>
            <div class="tab" onclick="switchTab('chats', event)">Chats</div>
          </div>

          <div class="tab-content active" id="setup-tab">
            <div class="form-group">
              <label for="serverUrl">Server URL:</label>
              <input
                type="text"
                id="serverUrl"
                value="http://localhost:5000"
                placeholder="http://localhost:5000"
              />
            </div>

            <div class="form-group">
              <label for="userId">User ID:</label>
              <input type="text" id="userId" placeholder="Enter your user ID" />
            </div>

            <div class="form-group">
              <label for="jwtToken">JWT Token:</label>
              <input
                type="text"
                id="jwtToken"
                placeholder="Enter your JWT token"
              />
            </div>

            <button class="btn btn-primary" onclick="connect()">Connect</button>
            <button class="btn btn-danger" onclick="disconnect()">
              Disconnect
            </button>

            <div class="form-group" style="margin-top: 20px">
              <label for="adId">Ad ID:</label>
              <input type="text" id="adId" placeholder="Enter ad ID" />
            </div>

            <button class="btn btn-success" onclick="createAdChat()">
              Create Ad Chat
            </button>

            <div class="form-group" style="margin-top: 20px">
              <button class="btn btn-secondary" onclick="loadUserChats()">
                Load Chats (WebSocket)
              </button>
              <button
                class="btn btn-secondary"
                onclick="loadUserChatsViaRest()"
              >
                Load Chats (REST API)
              </button>
            </div>

            <div class="log-area" id="setupLog"></div>
          </div>

          <div class="tab-content" id="chats-tab">
            <h3>Your Chats</h3>
            <button class="btn btn-primary" onclick="loadUserChats()">
              Refresh Chats
            </button>
            <ul class="chat-list" id="chatList"></ul>
          </div>
        </div>

        <div class="chat-area">
          <div class="chat-header">
            <h3 id="currentChatTitle">No chat selected</h3>
            <div>
              <button class="btn btn-primary" onclick="loadMessages()">
                Refresh Messages
              </button>
              <button class="btn btn-success" onclick="markAsRead()">
                Mark as Read
              </button>
            </div>
          </div>

          <div class="chat-messages" id="chatMessages">
            <p style="text-align: center; color: #666; margin-top: 50px">
              Select a chat to start messaging
            </p>
          </div>

          <div class="chat-input">
            <div class="input-group">
              <input
                type="text"
                id="messageInput"
                placeholder="Type your message..."
                onkeypress="handleKeyPress(event)"
              />
              <button class="btn btn-primary" onclick="sendMessage()">
                Send
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let socket = null;
      let currentChatId = null;
      let currentUserId = null;

      function log(message, tab = 'setup') {
        const logElement = document.getElementById(tab + 'Log');
        if (logElement) {
          const timestamp = new Date().toLocaleTimeString();
          logElement.innerHTML += `[${timestamp}] ${message}\n`;
          logElement.scrollTop = logElement.scrollHeight;
        }
        console.log(message);
      }

      function switchTab(tabName, event = null) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach((tab) => {
          tab.classList.remove('active');
        });
        document.querySelectorAll('.tab').forEach((tab) => {
          tab.classList.remove('active');
        });

        // Show selected tab
        document.getElementById(tabName + '-tab').classList.add('active');

        // If event is provided (click), mark the clicked tab as active
        if (event && event.target) {
          event.target.classList.add('active');
        } else {
          // Find the tab by name and mark it as active
          const tabs = document.querySelectorAll('.tab');
          tabs.forEach((tab) => {
            if (tab.textContent.toLowerCase().includes(tabName.toLowerCase())) {
              tab.classList.add('active');
            }
          });
        }
      }

      function updateConnectionStatus(connected) {
        const statusElement = document.getElementById('connectionStatus');
        if (connected) {
          statusElement.textContent = 'Connected';
          statusElement.className = 'connection-status status-connected';
        } else {
          statusElement.textContent = 'Disconnected';
          statusElement.className = 'connection-status status-disconnected';
        }
      }

      function connect() {
        const serverUrl = document.getElementById('serverUrl').value;
        const userId = document.getElementById('userId').value;
        const jwtToken = document.getElementById('jwtToken').value;

        if (!serverUrl || !userId) {
          alert('Please enter server URL and user ID');
          return;
        }

        try {
          socket = io(serverUrl + '/chat', {
            auth: {
              userId: userId,
              token: jwtToken,
            },
            query: {
              userId: userId,
            },
          });

          socket.on('connect', () => {
            log('Connected to server', 'setup');
            updateConnectionStatus(true);
            currentUserId = userId;
          });

          socket.on('disconnect', () => {
            log('Disconnected from server', 'setup');
            updateConnectionStatus(false);
          });

          socket.on('newMessage', (message) => {
            log(`New message received: ${message.content}`, 'setup');
            if (message.chat === currentChatId) {
              addMessageToChat(message, false);
            }
          });

          socket.on('newChatCreated', (data) => {
            log(
              `New chat created for ad ${data.adId}: ${data.message}`,
              'setup',
            );
            // Automatically refresh chat list to show the new chat
            loadUserChats(() => {
              // Automatically select the new chat
              selectChat(data.chatId);
              // Switch to chats tab to show the new chat
              switchTab('chats');
            });
          });

          socket.on('connect_error', (error) => {
            log(`Connection error: ${error.message}`, 'setup');
            updateConnectionStatus(false);
          });
        } catch (error) {
          log(`Error connecting: ${error.message}`, 'setup');
        }
      }

      function disconnect() {
        if (socket) {
          socket.disconnect();
          socket = null;
          updateConnectionStatus(false);
          log('Disconnected', 'setup');
        }
      }

      function createAdChat() {
        const adId = document.getElementById('adId').value;

        if (!adId) {
          alert('Please enter Ad ID');
          return;
        }

        if (socket) {
          // Try WebSocket first
          socket.emit('createAdChat', { adId }, (response) => {
            if (response.success) {
              log(
                `Chat created successfully via WebSocket: ${response.chat._id}`,
                'setup',
              );
              handleChatCreated(response.chat);
            } else {
              log(`WebSocket failed, trying REST API...`, 'setup');
              createAdChatViaRest(adId);
            }
          });
        } else {
          // Use REST API directly
          createAdChatViaRest(adId);
        }
      }

      function createAdChatViaRest(adId) {
        const serverUrl = document.getElementById('serverUrl').value;
        const jwtToken = document.getElementById('jwtToken').value;

        if (!serverUrl || !jwtToken) {
          log('Missing server URL or JWT token for REST API', 'setup');
          return;
        }

        fetch(`${serverUrl}/chat/ad/${adId}`, {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${jwtToken}`,
            'Content-Type': 'application/json',
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              log(
                `Chat created successfully via REST API: ${data.chat._id}`,
                'setup',
              );
              handleChatCreated(data.chat);
            } else {
              log(`REST API error: ${data.error || 'Unknown error'}`, 'setup');
            }
          })
          .catch((error) => {
            log(`REST API request failed: ${error.message}`, 'setup');
          });
      }

      function handleChatCreated(chat) {
        // Automatically select the newly created chat
        currentChatId = chat._id;
        document.getElementById('currentChatTitle').textContent =
          `Chat: ${chat._id}`;

        // Load user chats and then automatically select the new chat
        loadUserChats(() => {
          // After loading chats, automatically select the newly created one
          selectChat(chat._id);

          // Switch to chats tab to show the new chat
          switchTab('chats');
        });
      }

      function loadUserChats(callback) {
        if (!socket) {
          alert('Please connect first');
          return;
        }

        // Try WebSocket first, fallback to REST API
        socket.emit('getUserChats', {}, (response) => {
          if (response.success) {
            displayChats(response.chats);
            log(`Loaded ${response.chats.length} chats via WebSocket`, 'setup');

            // Execute callback if provided
            if (callback && typeof callback === 'function') {
              callback();
            }
          } else {
            log(`WebSocket failed, trying REST API...`, 'setup');
            loadUserChatsViaRest(callback);
          }
        });
      }

      function loadUserChatsViaRest(callback) {
        const serverUrl = document.getElementById('serverUrl').value;
        const jwtToken = document.getElementById('jwtToken').value;

        if (!serverUrl || !jwtToken) {
          log('Missing server URL or JWT token for REST API', 'setup');
          return;
        }

        fetch(`${serverUrl}/chat/user/with-messages`, {
          method: 'GET',
          headers: {
            Authorization: `Bearer ${jwtToken}`,
            'Content-Type': 'application/json',
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              displayChats(data.chats);
              log(`Loaded ${data.chats.length} chats via REST API`, 'setup');

              // Execute callback if provided
              if (callback && typeof callback === 'function') {
                callback();
              }
            } else {
              log(`REST API error: ${data.error || 'Unknown error'}`, 'setup');
            }
          })
          .catch((error) => {
            log(`REST API request failed: ${error.message}`, 'setup');
          });
      }

      function displayChats(chats) {
        const chatList = document.getElementById('chatList');
        chatList.innerHTML = '';

        chats.forEach((chat) => {
          const li = document.createElement('li');
          li.className = 'chat-item';

          // Create chat display with user names and last message
          let chatDisplay = '';

          if (chat.otherUser) {
            chatDisplay += `<strong>${chat.otherUser.name}</strong>`;
          } else {
            chatDisplay += '<strong>Unknown User</strong>';
          }

          if (chat.contextType === 'ad') {
            chatDisplay += ` <span style="color: #666; font-size: 0.9em;">(Ad: ${chat.contextId})</span>`;
          }

          if (chat.lastMessage) {
            const time = new Date(
              chat.lastMessage.createdAt,
            ).toLocaleTimeString();
            chatDisplay += `<br><small style="color: #888;">${chat.lastMessage.content.substring(0, 50)}${chat.lastMessage.content.length > 50 ? '...' : ''} - ${time}</small>`;
          } else {
            chatDisplay += `<br><small style="color: #888;">No messages yet</small>`;
          }

          li.innerHTML = chatDisplay;
          li.onclick = (event) => selectChat(chat._id, event);
          chatList.appendChild(li);
        });
      }

      function selectChat(chatId, event = null) {
        currentChatId = chatId;

        // Find the chat to get the other user's name
        const chatItem = event ? event.target.closest('.chat-item') : null;
        let chatTitle = `Chat: ${chatId}`;

        if (chatItem) {
          const userName = chatItem.querySelector('strong');
          if (userName) {
            chatTitle = `Chat with ${userName.textContent}`;
          }
        }

        document.getElementById('currentChatTitle').textContent = chatTitle;

        // Update active chat in list
        document.querySelectorAll('.chat-item').forEach((item) => {
          item.classList.remove('active');
        });

        // If event is provided (click), mark the clicked item as active
        if (event && event.target) {
          event.target.classList.add('active');
        } else {
          // Find the chat item by chatId and mark it as active
          const chatItems = document.querySelectorAll('.chat-item');
          chatItems.forEach((item) => {
            if (item.textContent.includes(chatId)) {
              item.classList.add('active');
            }
          });
        }

        loadMessages();
      }

      function loadMessages() {
        if (!socket || !currentChatId) {
          return;
        }

        socket.emit(
          'getChatMessages',
          { chatId: currentChatId },
          (response) => {
            if (response.success) {
              displayMessages(response.messages);
              log(`Loaded ${response.messages.length} messages`, 'setup');
            } else {
              log(`Error loading messages: ${response.error}`, 'setup');
            }
          },
        );
      }

      function displayMessages(messages) {
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = '';

        messages.forEach((message) => {
          const senderId =
            message.sender && message.sender._id
              ? message.sender._id
              : message.sender;
          addMessageToChat(message, senderId === currentUserId);
        });
      }

      function addMessageToChat(message, isSent) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;

        const timestamp = new Date(message.createdAt).toLocaleTimeString();
        const senderName =
          message.sender && message.sender.name
            ? message.sender.name
            : isSent
              ? 'You'
              : 'Other';

        messageDiv.innerHTML = `
                 <div class="message-header">${senderName} - ${timestamp}</div>
                 <div>${message.content}</div>
             `;

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function sendMessage() {
        if (!socket || !currentChatId) {
          alert('Please select a chat first');
          return;
        }

        const messageInput = document.getElementById('messageInput');
        const content = messageInput.value.trim();

        if (!content) {
          return;
        }

        socket.emit(
          'sendMessage',
          { chatId: currentChatId, content },
          (response) => {
            if (response.success) {
              messageInput.value = '';
              log(`Message sent successfully`, 'setup');
            } else {
              log(`Error sending message: ${response.error}`, 'setup');
            }
          },
        );
      }

      function handleKeyPress(event) {
        if (event.key === 'Enter') {
          sendMessage();
        }
      }

      function markAsRead() {
        if (!socket || !currentChatId) {
          alert('Please select a chat first');
          return;
        }

        socket.emit('markAsRead', { chatId: currentChatId }, (response) => {
          if (response.success) {
            log('Messages marked as read', 'setup');
          } else {
            log(`Error marking as read: ${response.error}`, 'setup');
          }
        });
      }

      // Auto-connect on page load if URL has parameters
      window.onload = function () {
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('userId');
        const jwtToken = urlParams.get('token');
        const serverUrl = urlParams.get('server') || 'http://localhost:5000';

        if (userId) {
          document.getElementById('userId').value = userId;
        }
        if (jwtToken) {
          document.getElementById('jwtToken').value = jwtToken;
        }
        if (serverUrl) {
          document.getElementById('serverUrl').value = serverUrl;
        }
      };
    </script>
  </body>
</html>
