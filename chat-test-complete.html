<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Complete Chat Test - All Features</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }
      .panel {
        border: 1px solid #ccc;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .log {
        background: #f5f5f5;
        padding: 10px;
        height: 200px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
      input,
      button,
      textarea {
        margin: 5px;
        padding: 8px;
      }
      .success {
        color: green;
      }
      .error {
        color: red;
      }
      .info {
        color: blue;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      .chat-list {
        height: 200px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
      }
      .chat-item {
        padding: 5px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
      }
      .chat-item:hover {
        background: #f0f0f0;
      }
      .chat-item.active {
        background: #e3f2fd;
      }
      .messages {
        height: 300px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
        background: #fafafa;
      }
      .message {
        margin: 5px 0;
        padding: 8px;
        border-radius: 5px;
      }
      .message.sent {
        background: #e3f2fd;
        text-align: right;
      }
      .message.received {
        background: #f5f5f5;
      }
      .message-input {
        width: 100%;
        height: 60px;
        resize: vertical;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Complete Chat Test - All Features</h1>

      <div class="panel">
        <h3>Configuration</h3>
        <input
          type="text"
          id="serverUrl"
          placeholder="Server URL"
          value="http://localhost:5000"
          style="width: 300px"
        />
        <input type="text" id="adId" placeholder="Ad ID" style="width: 200px" />
        <button onclick="getRealAdId()">Get Real Ad ID</button>
      </div>

      <div class="panel">
        <h3>Authentication</h3>
        <input
          type="text"
          id="username"
          placeholder="Username"
          value="user@example.com"
        />
        <input
          type="password"
          id="password"
          placeholder="Password"
          value="123456"
        />
        <button onclick="login()">Login</button>
        <div
          id="tokenDisplay"
          style="margin-top: 10px; font-size: 12px; word-break: break-all"
        ></div>
      </div>

      <div class="panel">
        <h3>WebSocket Connection</h3>
        <button onclick="connect()">Connect WebSocket</button>
        <button onclick="disconnect()">Disconnect</button>
        <button onclick="createAdChat()">Create Ad Chat</button>
        <button onclick="listChats()">List My Chats</button>
        <div id="connectionStatus">Disconnected</div>
      </div>

      <div class="grid">
        <div class="panel">
          <h3>Chat List</h3>
          <div id="chatList" class="chat-list"></div>
          <button onclick="refreshChats()">Refresh Chats</button>
        </div>

        <div class="panel">
          <h3>Messages</h3>
          <div id="messages" class="messages"></div>
          <textarea
            id="messageInput"
            class="message-input"
            placeholder="Type your message..."
          ></textarea>
          <button onclick="sendMessage()">Send Message</button>
          <button onclick="markAsRead()">Mark as Read</button>
        </div>
      </div>

      <div class="panel">
        <h3>Log</h3>
        <div id="log" class="log"></div>
        <button onclick="clearLog()">Clear Log</button>
      </div>
    </div>

    <script>
      let socket = null;
      let authToken = null;
      let currentChatId = null;
      let chats = [];

      function log(message, type = 'info') {
        const logDiv = document.getElementById('log');
        const timestamp = new Date().toLocaleTimeString();
        const className =
          type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
        logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function clearLog() {
        document.getElementById('log').innerHTML = '';
      }

      async function getRealAdId() {
        try {
          const serverUrl = document.getElementById('serverUrl').value;
          log('Getting real ad ID...');

          const response = await fetch(`${serverUrl}/ads/list`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ page: 1, limit: 1 }),
          });

          const data = await response.json();
          let ads = [];

          if (data.data) {
            ads = data.data;
          } else if (data.ads) {
            ads = data.ads;
          } else if (Array.isArray(data)) {
            ads = data;
          }

          if (ads.length > 0) {
            const adId = ads[0]._id || ads[0].id;
            document.getElementById('adId').value = adId;
            log(`Got real ad ID: ${adId}`, 'success');
          } else {
            log('No ads found in database', 'error');
          }
        } catch (error) {
          log(`Failed to get ad ID: ${error.message}`, 'error');
        }
      }

      async function login() {
        try {
          const serverUrl = document.getElementById('serverUrl').value;
          const username = document.getElementById('username').value;
          const password = document.getElementById('password').value;

          log('Logging in...');

          const response = await fetch(`${serverUrl}/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password }),
          });

          const data = await response.json();

          if (response.ok) {
            authToken = data.token || data.access_token || data.accessToken;
            document.getElementById('tokenDisplay').textContent =
              `Token: ${authToken.substring(0, 50)}...`;
            log('Login successful', 'success');
          } else {
            log(`Login failed: ${data.message || 'Unknown error'}`, 'error');
          }
        } catch (error) {
          log(`Login error: ${error.message}`, 'error');
        }
      }

      function connect() {
        if (!authToken) {
          log('Please login first to get a token', 'error');
          return;
        }

        const serverUrl = document.getElementById('serverUrl').value;
        const url = `${serverUrl}/chat`;

        log('Connecting to WebSocket...');

        socket = io(url, {
          transports: ['websocket'],
          auth: { token: authToken },
          autoConnect: false,
        });

        socket.on('connect', () => {
          document.getElementById('connectionStatus').textContent =
            `Connected (ID: ${socket.id})`;
          document.getElementById('connectionStatus').style.color = 'green';
          log('WebSocket connected successfully', 'success');
          refreshChats();
        });

        socket.on('connect_error', (error) => {
          document.getElementById('connectionStatus').textContent =
            'Connection failed';
          document.getElementById('connectionStatus').style.color = 'red';
          log(`Connection error: ${error.message}`, 'error');
        });

        socket.on('disconnect', (reason) => {
          document.getElementById('connectionStatus').textContent =
            'Disconnected';
          document.getElementById('connectionStatus').style.color = 'red';
          log(`Disconnected: ${reason}`, 'info');
        });

        socket.on('newChatCreated', (data) => {
          log(`New chat created: ${JSON.stringify(data)}`, 'success');
          refreshChats();
        });

        socket.on('message', (data) => {
          log(`Message received: ${JSON.stringify(data)}`, 'info');
          if (data.chatId === currentChatId) {
            addMessageToDisplay(data, false);
          }
        });

        socket.on('chatJoined', (data) => {
          log(`Joined chat: ${JSON.stringify(data)}`, 'success');
        });

        socket.connect();
      }

      function disconnect() {
        if (socket) {
          socket.disconnect();
          socket = null;
          document.getElementById('connectionStatus').textContent =
            'Disconnected';
          document.getElementById('connectionStatus').style.color = 'red';
          log('Disconnected manually', 'info');
        }
      }

      function createAdChat() {
        if (!socket || !socket.connected) {
          log('Please connect to WebSocket first', 'error');
          return;
        }

        const adId = document.getElementById('adId').value;
        if (!adId) {
          log('Please enter an Ad ID', 'error');
          return;
        }

        log(`Creating ad chat for ad ID: ${adId}`);

        socket.emit('createAdChat', { adId }, (response) => {
          if (response && response.success) {
            if (
              response.message &&
              response.message.includes('already exists')
            ) {
              log(`Chat already exists! Chat ID: ${response.chat._id}`, 'info');
            } else {
              log(
                `Chat created successfully! Chat ID: ${response.chat._id}`,
                'success',
              );
            }
            log(`Is new chat: ${response.isNewChat}`, 'info');
            currentChatId = response.chat._id;
            joinChat(currentChatId);
            refreshChats();
          } else {
            // Check if it's a duplicate key error
            if (
              response?.error &&
              response.error.includes('duplicate key error')
            ) {
              log('Chat already exists for this ad and user', 'info');
              log(
                'This is normal behavior - the chat was already created',
                'info',
              );
              // Try to refresh chats to show the existing one
              refreshChats();
            } else {
              log(
                `Failed to create chat: ${response?.error || 'Unknown error'}`,
                'error',
              );
            }
          }
        });
      }

      async function listChats() {
        if (!authToken) {
          log('Please login first', 'error');
          return;
        }

        try {
          const serverUrl = document.getElementById('serverUrl').value;
          const response = await fetch(`${serverUrl}/chat`, {
            headers: { Authorization: `Bearer ${authToken}` },
          });

          const data = await response.json();
          if (response.ok) {
            chats = data.chats || data.data || [];
            displayChats();
            log(`Found ${chats.length} chats`, 'success');
          } else {
            log(`Failed to list chats: ${data.message}`, 'error');
          }
        } catch (error) {
          log(`Error listing chats: ${error.message}`, 'error');
        }
      }

      function refreshChats() {
        if (socket && socket.connected) {
          socket.emit('getUserChats', {}, (response) => {
            if (response && response.success) {
              chats = response.chats || [];
              displayChats();
              log(`Refreshed chats: ${chats.length} found`, 'success');
            } else {
              log(
                'Failed to refresh chats via WebSocket, trying HTTP...',
                'error',
              );
              listChats();
            }
          });
        } else {
          listChats();
        }
      }

      function displayChats() {
        const chatList = document.getElementById('chatList');
        chatList.innerHTML = '';

        if (chats.length === 0) {
          chatList.innerHTML =
            '<div style="color: #666; text-align: center; padding: 20px;">No chats found</div>';
          return;
        }

        chats.forEach((chat) => {
          const chatItem = document.createElement('div');
          chatItem.className = 'chat-item';
          if (chat._id === currentChatId) {
            chatItem.classList.add('active');
          }

          const chatName =
            chat.contextType === 'ad'
              ? `Ad Chat (${chat.contextId})`
              : `Chat ${chat._id}`;
          const lastMessage = chat.lastMessage
            ? chat.lastMessage.content.substring(0, 30) + '...'
            : 'No messages';

          chatItem.innerHTML = `
                    <div><strong>${chatName}</strong></div>
                    <div style="font-size: 12px; color: #666;">${lastMessage}</div>
                `;

          chatItem.onclick = () => selectChat(chat._id);
          chatList.appendChild(chatItem);
        });
      }

      function selectChat(chatId) {
        currentChatId = chatId;
        log(`Selected chat: ${chatId}`, 'info');
        displayChats();
        joinChat(chatId);
        loadMessages(chatId);
      }

      function joinChat(chatId) {
        if (!socket || !socket.connected) {
          log('Please connect to WebSocket first', 'error');
          return;
        }

        socket.emit('joinChat', { chatId }, (response) => {
          if (response && response.success) {
            log(`Joined chat: ${chatId}`, 'success');
          } else {
            log(
              `Failed to join chat: ${response?.error || 'Unknown error'}`,
              'error',
            );
          }
        });
      }

      async function loadMessages(chatId) {
        if (!authToken) {
          log('Please login first', 'error');
          return;
        }

        try {
          const serverUrl = document.getElementById('serverUrl').value;
          const response = await fetch(
            `${serverUrl}/chat/${chatId}/messages?page=1&limit=50`,
            {
              headers: { Authorization: `Bearer ${authToken}` },
            },
          );

          const data = await response.json();
          if (response.ok) {
            const messages = data.messages || data.data || [];
            displayMessages(messages);
            log(`Loaded ${messages.length} messages`, 'success');
          } else {
            log(`Failed to load messages: ${data.message}`, 'error');
          }
        } catch (error) {
          log(`Error loading messages: ${error.message}`, 'error');
        }
      }

      function displayMessages(messages) {
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = '';

        if (messages.length === 0) {
          messagesDiv.innerHTML =
            '<div style="color: #666; text-align: center; padding: 20px;">No messages</div>';
          return;
        }

        messages.forEach((message) => {
          addMessageToDisplay(
            message,
            message.sender === '507f1f77bcf86cd799439025',
          ); // Assuming this is the current user ID
        });
      }

      function addMessageToDisplay(message, isSent) {
        const messagesDiv = document.getElementById('messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;

        const timestamp = new Date(
          message.createdAt || Date.now(),
        ).toLocaleTimeString();
        const sender = isSent ? 'You' : message.senderName || 'Other';

        messageDiv.innerHTML = `
                <div style="font-size: 12px; color: #666; margin-bottom: 2px;">${sender} - ${timestamp}</div>
                <div>${message.content}</div>
            `;

        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function sendMessage() {
        if (!socket || !socket.connected) {
          log('Please connect to WebSocket first', 'error');
          return;
        }

        if (!currentChatId) {
          log('Please select a chat first', 'error');
          return;
        }

        const messageInput = document.getElementById('messageInput');
        const content = messageInput.value.trim();

        if (!content) {
          log('Please enter a message', 'error');
          return;
        }

        socket.emit(
          'sendMessage',
          { chatId: currentChatId, content },
          (response) => {
            if (response && response.success) {
              log('Message sent successfully', 'success');
              messageInput.value = '';
              addMessageToDisplay({ content, createdAt: new Date() }, true);
            } else {
              log(
                `Failed to send message: ${response?.error || 'Unknown error'}`,
                'error',
              );
            }
          },
        );
      }

      function markAsRead() {
        if (!currentChatId) {
          log('Please select a chat first', 'error');
          return;
        }

        if (socket && socket.connected) {
          socket.emit('markAsRead', { chatId: currentChatId }, (response) => {
            if (response && response.success) {
              log('Messages marked as read', 'success');
            } else {
              log(
                `Failed to mark as read: ${response?.error || 'Unknown error'}`,
                'error',
              );
            }
          });
        } else {
          // HTTP fallback
          fetch(
            `${document.getElementById('serverUrl').value}/chat/${currentChatId}/read`,
            {
              method: 'POST',
              headers: { Authorization: `Bearer ${authToken}` },
            },
          )
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                log('Messages marked as read via HTTP', 'success');
              } else {
                log(`Failed to mark as read: ${data.message}`, 'error');
              }
            })
            .catch((error) =>
              log(`Error marking as read: ${error.message}`, 'error'),
            );
        }
      }

      // Handle Enter key in message input
      document
        .getElementById('messageInput')
        .addEventListener('keypress', function (e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });

      // Auto-get ad ID when page loads
      window.onload = function () {
        setTimeout(() => {
          getRealAdId();
        }, 1000);
      };
    </script>
  </body>
</html>
