<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ado-Dad Chat Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      .panel {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .chat-panel {
        grid-column: 1 / -1;
      }
      .message {
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
        background: #e3f2fd;
      }
      .message.sent {
        background: #e8f5e8;
        text-align: right;
      }
      .message.received {
        background: #fff3e0;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        font-weight: bold;
      }
      .status.connected {
        background: #d4edda;
        color: #155724;
      }
      .status.disconnected {
        background: #f8d7da;
        color: #721c24;
      }
      .status.connecting {
        background: #fff3cd;
        color: #856404;
      }
      input,
      button,
      select {
        padding: 8px;
        margin: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      button {
        background: #007bff;
        color: white;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      .chat-messages {
        height: 300px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
        margin: 10px 0;
        background: #fafafa;
      }
      .user-info {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <h1>Ado-Dad Chat System Test</h1>

    <div class="container">
      <div class="panel">
        <h3>Connection Settings</h3>
        <div class="user-info">
          <label
            >User ID:
            <input
              type="text"
              id="userId"
              placeholder="Enter your user ID"
              value="user123" /></label
          ><br />
          <label
            >Server URL:
            <input
              type="text"
              id="serverUrl"
              value="http://localhost:3000"
              style="width: 200px"
          /></label>
        </div>
        <button id="connectBtn" onclick="connect()">Connect</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>
          Disconnect
        </button>
        <div id="connectionStatus" class="status disconnected">
          Disconnected
        </div>
      </div>

      <div class="panel">
        <h3>Ad Chat Simulation</h3>
        <label
          >Ad ID:
          <input
            type="text"
            id="adId"
            placeholder="Enter ad ID"
            value="ad123" /></label
        ><br />
        <label
          >Ad Poster ID:
          <input
            type="text"
            id="adPosterId"
            placeholder="Enter ad poster ID"
            value="poster456" /></label
        ><br />
        <button onclick="createAdChat()">Create Ad Chat</button>
        <button onclick="joinChat()">Join Chat</button>
        <div id="chatInfo"></div>
      </div>

      <div class="panel chat-panel">
        <h3>Chat Messages</h3>
        <div class="chat-messages" id="chatMessages"></div>
        <div>
          <input
            type="text"
            id="messageInput"
            placeholder="Type your message..."
            style="width: 70%"
          />
          <button onclick="sendMessage()">Send</button>
        </div>
      </div>

      <div class="panel">
        <h3>Actions</h3>
        <button onclick="getUserChats()">Get My Chats</button>
        <button onclick="getChatMessages()">Get Chat Messages</button>
        <button onclick="markAsRead()">Mark as Read</button>
        <button onclick="clearMessages()">Clear Messages</button>
      </div>

      <div class="panel">
        <h3>Log</h3>
        <div
          id="log"
          style="
            height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 10px;
            border: 1px solid #ddd;
          "
        ></div>
      </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
      let socket;
      let currentChatId = null;
      let currentUserId = null;

      function log(message) {
        const logDiv = document.getElementById('log');
        const timestamp = new Date().toLocaleTimeString();
        logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(message);
      }

      function updateStatus(status, className) {
        const statusDiv = document.getElementById('connectionStatus');
        statusDiv.textContent = status;
        statusDiv.className = `status ${className}`;
      }

      function connect() {
        const serverUrl = document.getElementById('serverUrl').value;
        const userId = document.getElementById('userId').value;

        if (!userId) {
          alert('Please enter a User ID');
          return;
        }

        currentUserId = userId;
        log(`Connecting to ${serverUrl} as user ${userId}...`);
        updateStatus('Connecting...', 'connecting');

        socket = io(`${serverUrl}/chat`, {
          auth: { userId: userId },
          query: { userId: userId },
        });

        socket.on('connect', () => {
          log('Connected to server');
          updateStatus('Connected', 'connected');
          document.getElementById('connectBtn').disabled = true;
          document.getElementById('disconnectBtn').disabled = false;
        });

        socket.on('disconnect', () => {
          log('Disconnected from server');
          updateStatus('Disconnected', 'disconnected');
          document.getElementById('connectBtn').disabled = false;
          document.getElementById('disconnectBtn').disabled = true;
        });

        socket.on('newMessage', (message) => {
          log(`New message received: ${message.content}`);
          addMessageToChat(message, false);
        });

        socket.on('connect_error', (error) => {
          log(`Connection error: ${error.message}`);
          updateStatus('Connection Failed', 'disconnected');
        });
      }

      function disconnect() {
        if (socket) {
          socket.disconnect();
          socket = null;
        }
      }

      function createAdChat() {
        if (!socket) {
          alert('Please connect first');
          return;
        }

        const adId = document.getElementById('adId').value;
        const adPosterId = document.getElementById('adPosterId').value;

        if (!adId || !adPosterId) {
          alert('Please enter both Ad ID and Ad Poster ID');
          return;
        }

        log(`Creating ad chat for ad ${adId} with poster ${adPosterId}`);
        socket.emit('createAdChat', { adId, adPosterId }, (response) => {
          if (response.success) {
            currentChatId = response.chat._id;
            document.getElementById('chatInfo').innerHTML =
              `Chat ID: ${currentChatId}`;
            log(`Ad chat created successfully: ${currentChatId}`);
          } else {
            log(`Error creating ad chat: ${response.error}`);
          }
        });
      }

      function joinChat() {
        if (!socket || !currentChatId) {
          alert('Please connect and create a chat first');
          return;
        }

        log(`Joining chat: ${currentChatId}`);
        socket.emit('joinChat', { chatId: currentChatId }, (response) => {
          if (response.success) {
            log(`Joined chat: ${currentChatId}`);
          } else {
            log(`Error joining chat: ${response.error}`);
          }
        });
      }

      function sendMessage() {
        if (!socket || !currentChatId) {
          alert('Please connect and join a chat first');
          return;
        }

        const messageInput = document.getElementById('messageInput');
        const content = messageInput.value.trim();

        if (!content) {
          alert('Please enter a message');
          return;
        }

        log(`Sending message: ${content}`);
        socket.emit(
          'sendMessage',
          { chatId: currentChatId, content },
          (response) => {
            if (response.success) {
              log(`Message sent successfully`);
              addMessageToChat(response.message, true);
              messageInput.value = '';
            } else {
              log(`Error sending message: ${response.error}`);
            }
          },
        );
      }

      function addMessageToChat(message, isSent) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
        messageDiv.innerHTML = `
                <strong>${isSent ? 'You' : 'Other'}:</strong> ${message.content}
                <br><small>${new Date(message.createdAt || Date.now()).toLocaleTimeString()}</small>
            `;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function getUserChats() {
        if (!socket) {
          alert('Please connect first');
          return;
        }

        log('Getting user chats...');
        socket.emit('getUserChats', {}, (response) => {
          if (response.success) {
            log(`Found ${response.chats.length} chats`);
            response.chats.forEach((chat) => {
              log(
                `Chat ID: ${chat._id}, Type: ${chat.contextType}, Context: ${chat.contextId}`,
              );
            });
          } else {
            log(`Error getting chats: ${response.error}`);
          }
        });
      }

      function getChatMessages() {
        if (!socket || !currentChatId) {
          alert('Please connect and join a chat first');
          return;
        }

        log(`Getting messages for chat: ${currentChatId}`);
        socket.emit(
          'getChatMessages',
          { chatId: currentChatId },
          (response) => {
            if (response.success) {
              log(`Found ${response.messages.length} messages`);
              document.getElementById('chatMessages').innerHTML = '';
              response.messages.forEach((message) => {
                const isSent = message.sender === currentUserId;
                addMessageToChat(message, isSent);
              });
            } else {
              log(`Error getting messages: ${response.error}`);
            }
          },
        );
      }

      function markAsRead() {
        if (!socket || !currentChatId) {
          alert('Please connect and join a chat first');
          return;
        }

        log(`Marking messages as read for chat: ${currentChatId}`);
        socket.emit('markAsRead', { chatId: currentChatId }, (response) => {
          if (response.success) {
            log('Messages marked as read');
          } else {
            log(`Error marking as read: ${response.error}`);
          }
        });
      }

      function clearMessages() {
        document.getElementById('chatMessages').innerHTML = '';
        log('Chat messages cleared');
      }

      // Handle Enter key in message input
      document
        .getElementById('messageInput')
        .addEventListener('keypress', function (e) {
          if (e.key === 'Enter') {
            sendMessage();
          }
        });

      log('Chat test page loaded. Please connect to start testing.');
    </script>
  </body>
</html>
