version: '3.8'

services:
  # NestJS Application (Production - External MongoDB Atlas & Redis)
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: adodad_app
    environment:
      # ===========================================
      # APPLICATION CONFIGURATION
      # ===========================================
      NODE_ENV: production
      BACKEND_PORT: ${BACKEND_PORT:-5000}
      APP_CONFIG__BACKEND_PORT: ${APP_CONFIG__BACKEND_PORT:-5000}

      # ===========================================
      # DATABASE CONFIGURATION
      # ===========================================
      # MongoDB Configuration
      MONGODB_URI: ${MONGODB_URI}
      MONGO_URI: ${MONGO_URI}
      MONGO_USER: ${MONGO_USER}
      MONGO_PASSWORD: ${MONGO_PASSWORD}
      MONGO_HOST: ${MONGO_HOST}
      MONGO_PORT: ${MONGO_PORT:-27017}
      MONGO_DATABASE: ${MONGO_DATABASE}

      # ===========================================
      # REDIS CONFIGURATION
      # ===========================================
      # Redis Configuration
      REDIS_URL: ${REDIS_URL}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_DB: ${REDIS_DB:-0}

      # ===========================================
      # AUTHENTICATION & SECURITY
      # ===========================================
      JWT_SECRET: ${JWT_SECRET}
      TOKEN_KEY: ${TOKEN_KEY}
      SALT_ROUNDS: ${SALT_ROUNDS:-10}
      ACCESS_TOKEN_EXPIRY: ${ACCESS_TOKEN_EXPIRY:-86400000}
      REFRESH_TOKEN_EXPIRY: ${REFRESH_TOKEN_EXPIRY:-60d}

      # ===========================================
      # AWS CONFIGURATION
      # ===========================================
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION:-ap-south-1}
      AWS_S3_BUCKET: ${AWS_S3_BUCKET}
      AWS_S3_BUCKET_NAME: ${AWS_S3_BUCKET_NAME}

      # ===========================================
      # FIREBASE CONFIGURATION
      # ===========================================
      FIREBASE_SA_JSON: ${FIREBASE_SA_JSON}

      # ===========================================
      # EMAIL CONFIGURATION
      # ===========================================
      RESET_LINK: ${RESET_LINK}
      SES_FROM_EMAIL: ${SES_FROM_EMAIL}
      FRONTEND_URL: ${FRONTEND_URL}

      # ===========================================
      # GOOGLE MAPS CONFIGURATION
      # ===========================================
      GOOGLE_MAPS_API_KEY: ${GOOGLE_MAPS_API_KEY}
      API_KEY_MAPS: ${API_KEY_MAPS}
      API_SECRET_MAPS: ${API_SECRET_MAPS}
    ports:
      - '5000:5000'
    networks:
      - adodad_network
    healthcheck:
      test: ['CMD', 'node', 'healthcheck.js']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    stop_grace_period: 30s
    stop_signal: SIGTERM

networks:
  adodad_network:
    driver: bridge
