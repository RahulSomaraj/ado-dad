<!doctype html>
<html>
  <head>
    <title>WebSocket Test</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  </head>
  <body>
    <h1>WebSocket Connection Test</h1>
    <div id="status">Connecting...</div>
    <div id="logs"></div>

    <script>
      // This will be updated dynamically
      let token = '';

      function log(message) {
        const logs = document.getElementById('logs');
        logs.innerHTML +=
          '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
      }

      async function startTest() {
        try {
          // Step 1: Get fresh token
          log('Getting fresh authentication token...');
          const loginResponse = await fetch('http://localhost:5000/auth/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              username: 'user@example.com',
              password: '123456'
            })
          });
          
          const loginData = await loginResponse.json();
          token = loginData.token;
          log('✅ Token obtained: ' + token.substring(0, 50) + '...');
          
          // Step 2: Get a real ad ID
          log('Getting a real ad ID...');
          const adsResponse = await fetch('http://localhost:5000/ads/list', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              page: 1,
              limit: 1
            })
          });
          
          const adsData = await adsResponse.json();
          let ads = [];
          if (adsData.data) {
            ads = adsData.data;
          } else if (adsData.ads) {
            ads = adsData.ads;
          } else if (Array.isArray(adsData)) {
            ads = adsData;
          }
          
          if (ads.length === 0) {
            throw new Error('No ads found');
          }
          
          const adId = ads[0]._id || ads[0].id;
          log('✅ Using ad ID: ' + adId);
          
          // Step 3: Connect to WebSocket
          log('Attempting to connect to WebSocket...');
          
          const socket = io('http://localhost:5000/chat', {
            transports: ['websocket'],
            auth: {
              token: token,  // Send token without 'Bearer ' prefix
            },
            autoConnect: false,
          });

      socket.on('connect', () => {
        document.getElementById('status').innerHTML =
          'Connected! Socket ID: ' + socket.id;
        log('Connected successfully!');

        // Test createAdChat with real ad ID
        setTimeout(() => {
          log('Testing createAdChat with real ad ID...');
          socket.emit(
            'createAdChat',
            { adId: adId },
            (response) => {
              log('createAdChat response: ' + JSON.stringify(response));
            },
          );
        }, 1000);
      });

      socket.on('connect_error', (error) => {
        document.getElementById('status').innerHTML = 'Connection failed!';
        log('Connection error: ' + JSON.stringify(error));
      });

      socket.on('disconnect', (reason) => {
        document.getElementById('status').innerHTML = 'Disconnected: ' + reason;
        log('Disconnected: ' + reason);
      });

      socket.on('newChatCreated', (data) => {
        log('New chat created: ' + JSON.stringify(data));
      });

      socket.on('message', (data) => {
        log('Message received: ' + JSON.stringify(data));
      });

          socket.connect();
        } catch (error) {
          log('❌ Error: ' + error.message);
        }
      }
      
      // Start the test
      startTest();
    </script>
  </body>
</html>
